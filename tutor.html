<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SETOR WA || AMANGXD PANEL</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&family=Tilt+Neon&display=swap" rel="stylesheet"> 
  
  <style>
    body {
        font-family: 'Tilt Neon', sans-serif;
    }
    
    /* SweetAlert Custom Style */
    .swal2-popup {
      background-color: #1e293b !important;
      border: 1px solid #334155;
      color: #f8fafc !important;
      border-radius: 15px !important;
    }
    .swal2-title { color: #f8fafc !important; }
    .swal2-html-container { color: #cbd5e1 !important; }
    .swal2-input {
      background-color: #0f172a !important;
      color: white !important;
      border: 1px solid #475569 !important;
    }

    /* Typing Animation */
    .typing-animation {
      white-space: nowrap;
      overflow: hidden;
      border-right: 1px solid gold;
      animation: typing 2s steps(40, end), blink-caret 0.75s step-end infinite;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink-caret {
      from, to { border-color: transparent; }
      50% { border-color: white; }
    }

    /* Button Bounce Effect */
    .click-bounce { transition: transform 0.2s ease; }
    .click-bounce:active { animation: bounceTap 0.4s ease; }
    @keyframes bounceTap {
      0% { transform: scale(1); }
      40% { transform: scale(0.92); }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>

<body class="bg-slate-950 text-white min-h-screen flex items-center justify-center px-4 relative overflow-x-hidden">

  <div id="sidebar" class="fixed top-0 left-0 w-80 h-full bg-gray-900 shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 border-r border-gray-800">
    <div class="p-6 bg-gray-800 flex justify-between items-center rounded-b-lg shadow-lg border-b border-gray-700">
      <div>
        <h2 class="text-xl font-bold text-white tracking-wider">X-TOOLS <span class="text-blue-500">MENU</span></h2>
        <p class="text-gray-400 text-xs mt-1">Setor WA Automation</p>
      </div>
      <button id="close-sidebar" class="text-white hover:text-red-400 text-2xl transition"><i class="fas fa-times"></i></button>
    </div>
    
    <nav class="p-6 space-y-4 overflow-y-auto h-[calc(100%-100px)]">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Main Navigation</div>
      
      <a href="#" class="group flex items-center gap-4 py-3 px-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition transform hover:scale-[1.02] border border-gray-700 shadow-md">
        <i class="fa-brands fa-whatsapp text-green-400 text-xl"></i>
        <div>
          <span class="text-white font-semibold">Dashboard WA</span>
          <p class="text-gray-400 text-xs group-hover:text-gray-200">Pairing & Broadcast</p>
        </div>
      </a>

      <a href="#" onclick="openConfig()" class="group flex items-center gap-4 py-3 px-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition transform hover:scale-[1.02] border border-gray-700 shadow-md">
        <i class="fa-solid fa-gear text-blue-400 text-xl"></i>
        <div>
          <span class="text-white font-semibold">Config Pesan</span>
          <p class="text-gray-400 text-xs group-hover:text-gray-200">Atur isi broadcast</p>
        </div>
      </a>

      <div class="border-t border-gray-800 my-4"></div>

      <a href="#" class="group flex items-center gap-4 py-3 px-4 rounded-lg bg-gray-800 hover:bg-red-500/20 hover:border-red-500 transition transform hover:scale-[1.02] border border-gray-700">
        <i class="fas fa-sign-out-alt text-red-400 text-xl"></i>
        <div>
          <span class="text-white font-semibold group-hover:text-red-300">Logout</span>
          <p class="text-gray-400 text-xs">Keluar Panel</p>
        </div>
      </a>
    </nav>
  </div>
  
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40 backdrop-blur-sm"></div>

  <div class="w-full max-w-lg space-y-6 my-10">
    
    <div class="bg-gray-900 p-6 rounded-2xl shadow-2xl border border-gray-800 relative">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold typing-animation bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent inline-block">
          X-TOOLS || SETOR WA
        </h1>
        <div class="mt-4 relative group">
          <img src="https://telegra.ph/file/109c13b2e584501377749.jpg" 
               class="w-full h-40 object-cover rounded-xl shadow-lg border border-gray-700 opacity-80 group-hover:opacity-100 transition duration-500">
          
          <button id="menu-toggle" class="absolute bottom-3 right-3 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg shadow-lg click-bounce flex items-center gap-2">
            <i class="fa-solid fa-bars"></i> Menu
          </button>
        </div>
      </div>

      <div class="space-y-4">
        <div>
            <label class="block text-sm text-gray-400 mb-1 ml-1">Nomor WhatsApp (Target Pairing)</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa-solid fa-phone"></i>
              </span>
              <input type="number" id="pairingNumber" placeholder="628xxx"
                class="w-full pl-10 pr-4 py-3 rounded-xl bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
            </div>
        </div>

        <button onclick="requestPairing()" 
          class="w-full py-3 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 click-bounce flex justify-center items-center gap-2">
          <i class="fa-solid fa-link"></i> Request Pairing Code
        </button>
      </div>
    </div>

    <div id="session-container" class="space-y-4">
        <div class="text-center text-gray-500 py-4 animate-pulse">
            <i class="fa-solid fa-spinner fa-spin mr-2"></i> Memuat sesi aktif...
        </div>
    </div>

    <p class="text-center text-xs text-gray-600 mt-8">
      &copy; 2025 AmangXD Tools. All rights reserved.
    </p>

  </div>

<script>
    // Konfigurasi Username Session (Simulasi, di PHP ambil dari $_SESSION)
    const currentUsername = "AdminSession"; 
    const API_URL = window.location.origin;
    
    // --- UI INTERACTION ---
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuToggle = document.getElementById('menu-toggle');
    const closeSidebar = document.getElementById('close-sidebar');

    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    }

    menuToggle.addEventListener('click', toggleSidebar);
    closeSidebar.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    // --- API FUNCTIONS ---

    // 1. Request Pairing Code
    async function requestPairing() {
        const number = $('#pairingNumber').val();
        if (!number) return Swal.fire('Error', 'Masukkan nomor HP!', 'error');

        Swal.fire({
            title: 'Memproses...',
            text: 'Sedang meminta kode pairing...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await $.post(`${API_URL}/api/pair`, { 
                username: currentUsername, 
                number: number 
            });

            if (res.status) {
                Swal.fire({
                    title: 'Pairing Code',
                    html: `Kode Anda: <br><h1 class="text-4xl font-bold text-yellow-400 my-2 tracking-widest">${res.code}</h1><br>Silakan masukkan di WhatsApp Linked Devices.`,
                    icon: 'success',
                    background: '#1e293b',
                    color: '#fff'
                });
                loadSessions(); // Refresh list
            } else {
                Swal.fire('Gagal', res.message || 'Error pairing', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Gagal menghubungkan ke server', 'error');
        }
    }

    // 2. Load Sessions & Generate UI
    async function loadSessions() {
        try {
            const res = await $.get(`${API_URL}/api/sessions`);
            const container = $('#session-container');
            container.empty();

            if (res.sessions.length === 0) {
                container.html(`
                    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 text-center text-gray-500">
                        <i class="fa-solid fa-plug-circle-xmark text-4xl mb-2 text-gray-700"></i>
                        <p>Belum ada sesi yang terhubung.</p>
                    </div>
                `);
                return;
            }

            res.sessions.forEach(session => {
                // Hanya tampilkan sesi milik user ini (jika multi-user)
                // Di demo ini kita tampilkan semua atau filter by username
                const isConnected = session.status === 'Connected';
                const statusColor = isConnected ? 'text-green-400' : 'text-red-400';
                const borderStatus = isConnected ? 'border-green-500/30' : 'border-red-500/30';

                const html = `
                <div class="bg-gray-900 rounded-2xl border ${borderStatus} shadow-lg overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-1 h-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}"></div>
                    
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                                    <i class="fa-brands fa-whatsapp text-green-500"></i> 
                                    ${session.username}
                                </h3>
                                <p class="text-xs text-gray-400 mt-1">Number: <span class="font-mono text-blue-300">${session.number}</span></p>
                            </div>
                            <span class="text-xs font-bold uppercase ${statusColor} bg-gray-800 px-2 py-1 rounded border border-gray-700">
                                ${session.status}
                            </span>
                        </div>

                        <div class="bg-gray-800/50 rounded-xl p-3 border border-gray-700 space-y-3">
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">Kecepatan Broadcast</label>
                                <select id="speed-${session.username}" class="w-full bg-gray-900 text-sm text-white border border-gray-600 rounded-lg p-2 focus:ring-1 focus:ring-blue-500 outline-none">
                                    <option value="very_fast">üöÄ Very Fast (0.5s - 1s)</option>
                                    <option value="fast">‚è© Fast (2s - 5s)</option>
                                    <option value="slow" selected>üêå Slow (5s - 10s)</option>
                                    <option value="very_slow">üê¢ Very Slow (20s - 50s)</option>
                                </select>
                            </div>

                            <div class="flex gap-2">
                                <button onclick="startBroadcast('${session.username}')" 
                                    class="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-2 rounded-lg transition click-bounce">
                                    <i class="fa-solid fa-paper-plane mr-1"></i> Start BC
                                </button>
                                
                                <button onclick="checkStats('${session.number}')" 
                                    class="w-10 bg-gray-700 hover:bg-gray-600 text-blue-400 text-sm font-bold py-2 rounded-lg transition click-bounce"
                                    title="Cek Statistik">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </button>
                            </div>
                        </div>

                        <div id="stats-area-${session.number.replace(/\D/g,'')}" class="mt-3 text-xs flex justify-between items-center text-gray-500 bg-black/20 p-2 rounded hidden">
                           <span><i class="fa-solid fa-check text-green-500"></i> Sent: <b id="stat-sent-${session.number.replace(/\D/g,'')}">0</b></span>
                           <span><i class="fa-solid fa-xmark text-red-500"></i> Fail: <b id="stat-fail-${session.number.replace(/\D/g,'')}">0</b></span>
                        </div>
                    </div>
                </div>
                `;
                container.append(html);
                
                // Trigger auto-check stats on load
                if(session.number !== '-') {
                    fetchStats(session.number);
                }
            });

        } catch (e) {
            console.error("Load sessions error", e);
        }
    }

    // 3. Broadcast Function
    async function startBroadcast(sessionUser) {
        const speed = $(`#speed-${sessionUser}`).val();
        
        Swal.fire({
            title: 'Mulai Broadcast?',
            text: `Sesi: ${sessionUser} | Speed: ${speed}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#16a34a',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Gas!',
            background: '#1e293b',
            color: '#fff'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await $.post(`${API_URL}/api/broadcast`, {
                        username: sessionUser,
                        speed: speed
                    });
                    
                    if(res.status) {
                        Swal.fire('Berhasil', 'Broadcast sedang berjalan di background.', 'success');
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', e.responseText || 'Server error', 'error');
                }
            }
        });
    }

    // 4. Fetch Stats (Polling Implementation)
    function fetchStats(number) {
        // Membersihkan nomor untuk ID selector
        const cleanNum = number.replace(/\D/g,'');
        if(!cleanNum) return;

        // Panggil endpoint cek-terkirim
        $.post(`${API_URL}/api/cek-terkirim`, { number: cleanNum })
        .done(function(res) {
            if(res.status) {
                // Tampilkan area stats
                $(`#stats-area-${cleanNum}`).removeClass('hidden');
                // Update angka
                $(`#stat-sent-${cleanNum}`).text(res.stats.successful_sends);
                $(`#stat-fail-${cleanNum}`).text(res.stats.failed_sends);
            }
        })
        .fail(function() {
            // Hide jika error/belum ada log
            // $(`#stats-area-${cleanNum}`).addClass('hidden');
        });
    }

    // 5. Config Pesan Modal
    async function openConfig() {
        // Ambil config saat ini
        let currentConfig = {};
        try { currentConfig = await $.get(`${API_URL}/api/message-config`); } catch(e){}

        Swal.fire({
            title: 'Konfigurasi Pesan',
            html: `
                <input id="cfg-title" class="swal2-input" placeholder="Judul Broadcast" value="${currentConfig.title || ''}">
                <textarea id="cfg-msg" class="swal2-textarea" placeholder="Isi Pesan" style="background:#0f172a; color:white;">${currentConfig.message || ''}</textarea>
                <input id="cfg-footer" class="swal2-input" placeholder="Footer" value="${currentConfig.footer || ''}">
                <input id="cfg-btn-text" class="swal2-input" placeholder="Teks Tombol Link" value="${currentConfig.btn_text || ''}">
                <input id="cfg-btn-url" class="swal2-input" placeholder="URL Link" value="${currentConfig.btn_url || ''}">
                <input id="cfg-media" class="swal2-input" placeholder="URL Gambar/Video (Opsional)" value="${currentConfig.media_url || ''}">
            `,
            confirmButtonText: 'Simpan',
            focusConfirm: false,
            background: '#1e293b',
            color: '#fff',
            preConfirm: () => {
                return {
                    title: document.getElementById('cfg-title').value,
                    message: document.getElementById('cfg-msg').value,
                    footer: document.getElementById('cfg-footer').value,
                    btn_text: document.getElementById('cfg-btn-text').value,
                    btn_url: document.getElementById('cfg-btn-url').value,
                    media_url: document.getElementById('cfg-media').value,
                    media_type: 'image' // Default image
                }
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                await $.post('http://localhost:5036/api/save-message', result.value);
                Swal.fire('Tersimpan', 'Konfigurasi pesan diperbarui.', 'success');
            }
        });
    }

    // --- AUTO RUN ---
    $(document).ready(() => {
        // SweetAlert Welcome
        Swal.fire({
            title: `üëã Hai, <span style="color:#60a5fa">${currentUsername}</span>!`,
            html: `
              <div style="text-align: left; font-size: 14px; padding: 5px; color: #cbd5e1;">
                <p>Selamat datang di <b style="color:#facc15">SETOR WA PANEL</b>.</p>
                <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-400">
                    <li>Gunakan fitur ini dengan bijak.</li>
                    <li>Pastikan config pesan sudah diisi sebelum broadcast.</li>
                    <li>Sistem otomatis akan scraping nomor dari grup.</li>
                </ul>
              </div>
            `,
            background: '#0f172a',
            color: '#f8fafc',
            confirmButtonText: 'Lanjut',
            confirmButtonColor: '#2563eb',
        });

        loadSessions();

        // Polling Data Setiap 5 Detik untuk update status terkirim
        setInterval(() => {
            $('.bg-gray-900').each(function() {
                // Cari nomor dari elemen DOM yang sudah dirender
                // (Ini cara kasar, idealnya simpan list sesi di variabel global)
                // Tapi untuk demo ini cukup efektif.
                const btn = $(this).find('button[onclick^="checkStats"]');
                if(btn.length) {
                    const onclickVal = btn.attr('onclick');
                    const num = onclickVal.match(/'([^']+)'/)[1];
                    if(num && num !== '-') fetchStats(num);
                }
            });
        }, 5000); // 5 detik
    });

</script>
</body>
</html>
